window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){return window.setTimeout(function(){return a(+(new Date))},1e3/60)});var Game;Game=function(){function a(){var a;this.input=new Input,this.loader=new Loader,a=this,this.step_callback=function(b){return a.step(b)},this.loader.loadComplete(function(){return a.start()})}return a.prototype.start=function(){return this.step()},a.prototype.step=function(){return console.log("Implement me!!!")},a.prototype.next=function(){return window.requestAnimationFrame(this.step_callback)},a}();var Loader;Loader=function(){function a(){this.progress=0,this.assets={},this.totalAssets=0,this.loadedAssets=0}return a.prototype.updateProgress=function(){this.progress=this.loadedAssets/this.totalAssets;if(this.progress===1&&this.onload)return this.onload()},a.prototype.load=function(a){var b,c,d;d=[];for(c in a)b=a[c],d.push(this.loadAsset(c,b));return d},a.prototype.loadAsset=function(a,b){var c,d;return c=new Image,d=this,c.onload=function(){return this.loaded=!0,d.loadedAssets++,d.updateProgress()},this.assets[a]={loader:this,src:b,image:c},this.totalAssets++,c.src=b},a.prototype.loadComplete=function(a){return this.onload=a},a.prototype.getAsset=function(a){return this.assets[a].image},a}();var Input;Input=function(){function a(){var a,b,c,d;this.keys={},d=this.keys,c=function(a){return a.which||(a.which=a.charCode),a.which||(a.which=a.keyCode),a},a=function(a){return d["key"+c(a).which]=!0},b=function(a){return d["key"+c(a).which]=!1},document.onkeydown=a,document.onkeyup=b,this.shortcuts={left:["key37","key65"],right:["key39","key68"],up:["key38","key87"],down:["key40","key83"]}}return a.prototype.left=function(a){return this.keys[this.shortcuts.left[a]]||!1},a.prototype.right=function(a){return this.keys[this.shortcuts.right[a]]||!1},a.prototype.up=function(a){return this.keys[this.shortcuts.up[a]]||!1},a.prototype.down=function(a){return this.keys[this.shortcuts.down[a]]||!1},a}();var World;World=function(){function a(a,b){var c;this.bg=b,this.canvas=document.getElementById(a),this.ctx=this.canvas.getContext("2d"),this.width=parseFloat(this.canvas.width),this.height=parseFloat(this.canvas.height),this.ctx._world=this,c=new Box2D.Common.Math.b2Vec2(0,100),this.world=new Box2D.Dynamics.b2World(c,!0),this.sprites=[],this.oldTime=new Date}return a.prototype.addStaticSprite=function(a){return this.sprites.push({sprite:a})},a.prototype.addSprite=function(a){var b;return b=this.world.CreateBody(a.body),b.CreateFixture(a.fixture),this.sprites.push({sprite:a,body:b})},a.prototype.draw=function(){var a,b,c,d,e;this.ctx.clearRect(0,0,this.width,this.height),d=this.sprites,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],a.body&&a.sprite.updateBody(a.body,this),e.push(a.sprite.draw(this.ctx));return e},a.prototype.step=function(a){var b;return b=a-this.oldTime,this.oldTime=a,this.world.Step(b/1e3,10,10),this.world.ClearForces()},a}();var Sprite;Sprite=function(){function a(a,b,c,d){this.x=a,this.y=b,this.width=c,this.height=d,this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.createBody()}return a.prototype.createBody=function(){return this.body=null},a.prototype.updateBody=function(a,b){if(a)return this.x=a.GetPosition().x,this.y=a.GetPosition().y,this.m_body=a},a.prototype.draw=function(a){return console.log("Override me!")},a}();var StretchySprite,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};StretchySprite=function(){function a(b,c,d,e,f,g,h){this.x=b,this.y=c,this.width=d,this.height=e,this.rightCap=f,this.topCap=g,this.bg=h,this.generateStretchedImage(),a.__super__.constructor.call(this,this.x,this.y,this.width,this.height)}return __extends(a,Sprite),a.prototype.generateStretchedImage=function(){var a,b,c,d,e,f,g,h;return a=function(a,b){var c;return c=document.createElement("canvas"),c.width=a,c.height=b,c},f=a(this.width,2),c=a(8,this.height),g=f.getContext("2d"),g.drawImage(this.bg,0,this.topCap,this.bg.width,1,0,0,this.width,f.height),d=c.getContext("2d"),d.drawImage(this.bg,this.bg.width-this.rightCap-c.width,0,c.width,this.bg.height,0,this.height-this.bg.height,c.width,this.bg.height),this.stretchedImage=a(this.width,this.height),b=this.stretchedImage.getContext("2d"),b.drawImage(this.bg,this.x,this.y+this.height-this.bg.height),e=b.createPattern(c,"repeat-x"),b.fillStyle=e,b.fillRect(this.bg.width-this.rightCap,this.height-this.bg.height,this.width-this.bg.width,this.bg.height),h=b.createPattern(f,"repeat-y"),b.fillStyle=h,b.fillRect(0,this.topCap,this.width,this.height-this.bg.height),b.drawImage(this.bg,0,0,this.bg.width,this.topCap,0,0,this.width,this.topCap),b.drawImage(this.bg,this.bg.width-this.rightCap,0,this.rightCap,this.bg.height,this.width-this.rightCap,this.height-this.bg.height,this.rightCap,this.bg.height)},a.prototype.draw=function(a){return a.drawImage(this.stretchedImage,0,0)},a}();var SlimeVolleyball,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};SlimeVolleyball=function(){function a(){a.__super__.constructor.apply(this,arguments)}return __extends(a,Game),a.prototype.load=function(){return this.loader.load({p1:"assets/images/s_0.png",p2:"assets/images/s_1.png",bg:"assets/images/bg.png"})},a.prototype.start=function(){var b,c,d,e,f,g,h;this.world=new World("canvas",this.interval),this.bg=new StretchySprite(0,0,this.world.width,this.world.height,200,1,this.loader.getAsset("bg")),this.p1=new Slime(100,200,"#0f0",this.loader.getAsset("p1")),this.p2=new Slime(300,200,"#00f",this.loader.getAsset("p2")),this.ball=new Ball(230,21),this.p1.ball=this.ball,this.p2.ball=this.ball,this.p2.isP2=!0,this.world.addStaticSprite(this.bg),this.world.addSprite(this.p1),this.world.addSprite(this.p2),this.world.addSprite(this.ball),b=60,e=1,d=1e3,f=[new Box(-e,-1e3,e,2e3),new Box(0,this.world.height-b+this.p1.radius,this.world.width,e),new Box(this.world.width,-1e3,e,2e3)];for(g=0,h=f.length;g<h;g++)c=f[g],this.world.addSprite(c);return a.__super__.start.call(this)},a.prototype.step=function(a){return this.next(),this.p1.handleInput(this.input,this.world),this.p2.handleInput(this.input,this.world),this.world.draw(),this.world.step(a)},a}(),window.onload=function(){var a;return a=new SlimeVolleyball,a.load()};var Slime,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};Slime=function(){function a(b,c,d,e){this.x=b,this.y=c,this.color=d,this.img=e,this.radius=31,this.isP2=!1,a.__super__.constructor.call(this,this.x,this.y,this.radius*2,this.radius*2)}return __extends(a,Sprite),a.prototype.createBody=function(){return this.fixture=new Box2D.Dynamics.b2FixtureDef,this.fixture.density=1,this.fixture.friction=1,this.fixture.restitution=0,this.fixture.shape=new Box2D.Collision.Shapes.b2CircleShape(this.radius),this.body=new Box2D.Dynamics.b2BodyDef,this.body.type=Box2D.Dynamics.b2Body.b2_dynamicBody,this.body.position.Set(this.x,this.y)},a.prototype.handleInput=function(a,b){var c,d,e;this.m_body&&(e=b.height-this.m_body.GetPosition().y),d=this.isP2?1:0,c=100,a.left(d)&&(this.m_body.m_linearVelocity.x=-40,this.m_body.SetAwake(!0)),a.right(d)&&(this.m_body.m_linearVelocity.x=40,this.m_body.SetAwake(!0)),a.up(d)&&e<c&&(this.m_body.m_linearVelocity.y=-100,this.m_body.SetAwake(!0));if(a.down(d)){if(this.m_body.m_linearVelocity.y>0&&e>c)return this.m_body.m_linearVelocity.y*=1.5}else if(this.m_body&&e<c)return this.m_body.m_linearVelocity.x/=1.1},a.prototype.draw=function(a){var b,c,d,e,f;return a.fillStyle="#000",a.fillRect(this.x,this.y,3,3),a.drawImage(this.img,this.x-this.radius-1,this.y-this.radius),f=this.radius/2,e=f*.95,this.isP2&&(e=-e),c=new Box2D.Common.Math.b2Vec2(this.x+e,this.y-f),d=new Box2D.Common.Math.b2Vec2(e,f),b=new Box2D.Common.Math.b2Vec2(this.ball.x,this.ball.y),b.Subtract(c),b.y=-b.y,b.Normalize(),b.Multiply(3),b.Add(d),a.fillStyle="#000",a.beginPath(),a.arc(this.x+b.x,this.y-b.y,2,0,Math.PI*2,!0),a.closePath(),a.fill()},a}();var Box,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};Box=function(){function a(b,c,d,e){this.x=b,this.y=c,this.width=d,this.height=e,this.color="#444",a.__super__.constructor.apply(this,arguments)}return __extends(a,Sprite),a.prototype.createBody=function(){return this.fixture=new Box2D.Dynamics.b2FixtureDef,this.fixture.friction=1,this.fixture.restitution=0,this.fixture.shape=new Box2D.Collision.Shapes.b2PolygonShape,this.fixture.shape.SetAsBox(this.width,this.height),this.body=new Box2D.Dynamics.b2BodyDef,this.body.type=Box2D.Dynamics.b2Body.b2_staticBody,this.body.position.Set(this.x,this.y)},a.prototype.draw=function(a){return a.fillStyle="#000",a.fillRect(this.x,this.y,this.width,this.height)},a}();var Ball,__hasProp=Object.prototype.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};Ball=function(){function a(b,c,d){this.x=b,this.y=c,this.bg=d,this.radius=10,this.color="#000000",a.__super__.constructor.call(this,this.x,this.y,this.radius*2,this.radius*2)}return __extends(a,Sprite),a.prototype.createBody=function(){return this.fixture=new Box2D.Dynamics.b2FixtureDef,this.fixture.density=.4,this.fixture.friction=.5,this.fixture.restitution=.2,this.fixture.shape=new Box2D.Collision.Shapes.b2CircleShape(this.radius),this.body=new Box2D.Dynamics.b2BodyDef,this.body.type=Box2D.Dynamics.b2Body.b2_dynamicBody,this.body.position.Set(this.x,this.y)},a.prototype.draw=function(a){return a.fillStyle=this.color,a.beginPath(),a.arc(this.x,this.y,this.radius,0,Math.PI*2,!0),a.closePath(),a.fill()},a}()